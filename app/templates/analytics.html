<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - OCR Pipeline</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .analytics-container {
            padding: 20px 0;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .metric-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }

        .metric-icon {
            font-size: 24px;
            margin-bottom: 12px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 20px 0;
            color: #333;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .data-table {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:hover {
            background: #f9f9f9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            color: #c33;
        }

        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .metric-value {
                font-size: 24px;
            }

            .chart-wrapper {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="https://parasail.io" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    Parasail
                </a>
                <span style="color: #ccc; margin: 0 8px;">|</span>
                <span class="logo-icon">üìÑ</span>
                OCR Pipeline
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link">Upload</a>
                <a href="/documents" class="nav-link">Documents</a>
                <a href="/schemas" class="nav-link">Schemas</a>
                <a href="/models" class="nav-link">Models</a>
                <a href="/analytics" class="nav-link active">Analytics</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="analytics-container">
            <h1>üìä Analytics Dashboard</h1>
            
            <div id="loading" class="loading">
                Loading analytics data...
            </div>

            <div id="error" class="error" style="display: none;"></div>

            <div id="analytics-content" style="display: none;">
                <!-- Key Metrics -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon">üìù</div>
                        <div class="metric-label">Total Requests (30d)</div>
                        <div class="metric-value" id="total-requests">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">ü§ñ</div>
                        <div class="metric-label">Active Models</div>
                        <div class="metric-value" id="active-models">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üî¢</div>
                        <div class="metric-label">Total Tokens</div>
                        <div class="metric-value" id="total-tokens">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üåê</div>
                        <div class="metric-label">Unique IPs</div>
                        <div class="metric-value" id="unique-ips">0</div>
                    </div>
                </div>

                <!-- Requests Per Day Chart -->
                <div class="chart-container">
                    <h2 class="chart-title">Requests Per Day (Last 30 Days)</h2>
                    <div class="chart-wrapper">
                        <canvas id="requests-chart"></canvas>
                    </div>
                </div>

                <!-- Model Usage Chart -->
                <div class="chart-container">
                    <h2 class="chart-title">Model Usage Distribution</h2>
                    <div class="chart-wrapper">
                        <canvas id="model-usage-chart"></canvas>
                    </div>
                </div>

                <!-- Token Usage Table -->
                <div class="data-table">
                    <h2 class="chart-title">Token Usage by Model</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Prompt Tokens</th>
                                <th>Completion Tokens</th>
                                <th>Total Tokens</th>
                            </tr>
                        </thead>
                        <tbody id="tokens-table-body">
                        </tbody>
                    </table>
                </div>

                <!-- Performance Table -->
                <div class="data-table" style="margin-top: 20px;">
                    <h2 class="chart-title">Performance Metrics by Model</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Avg Duration (ms)</th>
                                <th>Avg Tokens</th>
                                <th>ms per Token</th>
                                <th>Requests</th>
                            </tr>
                        </thead>
                        <tbody id="performance-table-body">
                        </tbody>
                    </table>
                </div>

                <!-- IP Addresses Table -->
                <div class="data-table" style="margin-top: 20px;">
                    <h2 class="chart-title">Request Sources</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Request Count</th>
                            </tr>
                        </thead>
                        <tbody id="ip-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let requestsChart = null;
        let modelUsageChart = null;

        async function loadAnalytics() {
            try {
                const response = await fetch('/api/analytics/overview');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('analytics-content').style.display = 'block';
                
                renderMetrics(data);
                renderRequestsChart(data.requests_per_day);
                renderModelUsageChart(data.model_usage_counts);
                renderTokensTable(data.tokens_per_model);
                renderPerformanceTable(data.performance_per_model);
                renderIPTable(data.ip_addresses);
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = 'Failed to load analytics data: ' + error.message;
                document.getElementById('error').style.display = 'block';
            }
        }

        function renderMetrics(data) {
            const totalRequests = data.requests_per_day.reduce((sum, day) => sum + day.count, 0);
            const totalTokens = data.tokens_per_model.reduce((sum, model) => sum + model.total_tokens, 0);
            
            document.getElementById('total-requests').textContent = totalRequests.toLocaleString();
            document.getElementById('active-models').textContent = data.model_usage_counts.length;
            document.getElementById('total-tokens').textContent = totalTokens.toLocaleString();
            document.getElementById('unique-ips').textContent = data.unique_ips_count;
        }

        function renderRequestsChart(requestsPerDay) {
            const ctx = document.getElementById('requests-chart');
            
            if (requestsChart) {
                requestsChart.destroy();
            }

            requestsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: requestsPerDay.map(d => d.date),
                    datasets: [{
                        label: 'Requests',
                        data: requestsPerDay.map(d => d.count),
                        backgroundColor: 'rgba(103, 58, 183, 0.6)',
                        borderColor: 'rgba(103, 58, 183, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        function renderModelUsageChart(modelUsageCounts) {
            const ctx = document.getElementById('model-usage-chart');
            
            if (modelUsageChart) {
                modelUsageChart.destroy();
            }

            const colors = [
                'rgba(103, 58, 183, 0.8)',
                'rgba(33, 150, 243, 0.8)',
                'rgba(76, 175, 80, 0.8)',
                'rgba(255, 152, 0, 0.8)',
                'rgba(244, 67, 54, 0.8)',
            ];

            modelUsageChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: modelUsageCounts.map(m => m.model),
                    datasets: [{
                        data: modelUsageCounts.map(m => m.count),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function renderTokensTable(tokensPerModel) {
            const tbody = document.getElementById('tokens-table-body');
            tbody.innerHTML = '';
            
            tokensPerModel.forEach(model => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${model.model}</strong></td>
                    <td>${model.prompt_tokens.toLocaleString()}</td>
                    <td>${model.completion_tokens.toLocaleString()}</td>
                    <td><strong>${model.total_tokens.toLocaleString()}</strong></td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderPerformanceTable(performancePerModel) {
            const tbody = document.getElementById('performance-table-body');
            tbody.innerHTML = '';
            
            performancePerModel.forEach(model => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${model.model}</strong></td>
                    <td>${model.avg_duration_ms.toLocaleString()} ms</td>
                    <td>${model.avg_tokens.toLocaleString()}</td>
                    <td><strong>${model.ms_per_token}</strong></td>
                    <td>${model.count}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderIPTable(ipAddresses) {
            const tbody = document.getElementById('ip-table-body');
            tbody.innerHTML = '';
            
            ipAddresses.forEach(ip => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><code>${ip.ip_address}</code></td>
                    <td>${ip.count}</td>
                `;
                tbody.appendChild(row);
            });
        }

        loadAnalytics();
    </script>
</body>
</html>
